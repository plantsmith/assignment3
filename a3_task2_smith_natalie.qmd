---
title: "Non-linear Least Squares"
author: "Natalie Smith"
format: 
  html:
    code-fold: true
    toc: true
    number-sections: true
    embed-resources: true
theme: Yeti
editor: visual
execute:
  echo: true
  message: false
  warning: false
---
# Overview: 
Farmers need to understand the biology of plants and their responses to fertilizers to maximize yield. You will help farmers make predictions on their yields by running non-linear least squares on experimental growth data for three grains in Greece. 

Additionally, you will assess the response of the grains to fertlizer. 

You will recreate the model examples of Archontoulis, S.V. and Miguez, F.E. (2015). Read the paper to acquire more insight into nonlinear least squares and its application in agriculture. 

```{r}
library(tidyverse)
library(lterdatasampler)
library(knitr)
library(broom)
library(investr)
library(kableExtra)
library(nlraa)
library(janitor)
```


```{r}
# Access the data from SM package in NLRAA
data <- sm
#clean the data
crop_data <- data %>% 
  janitor::clean_names()
```

# Variables:

Write a brief description of the data including variable names and structure. 

Variables: 
DOY: Day of Year
Block: location
Input: 
  High = weekly irrigation & applicaton of 200 kg N ha^-1 (fertilizer)
  Low = biweekly irrigation.& application of 50 kg N ha^-1 (fertilizer)
Crop: 
  (F) fiber sorghum
  (S) sweet sorghum 
  (M) maize 
Yield: Biomass

Create finalized summary table of the data in your report. 

Use the Beta function:

Briefly describe what each parameter generally means: 
Y is the response variable (e.g., biomass)
t is the explanatory variable (e.g., time)
Ymax is the asymptotic or the maximum Y value, respectively
tm is the inflection point at which the growth rate is maximized
k controls the steepness of the curve
v deals with the asymmetric growth (if v = 1, then Richards' equation becomes logistic)
a and b are parameters that determine the shape of the curve
te is the time when Y = Yasym
tc is the critical time for a switch-off to occur (e.g., critical photoperiod)
n is a parameter that determines the sharpness of the response

Notes from paper:
* Three crops
* two levels of agronomic input
* four blocks
* = 24 possible combinations 

Write a function in R to model the Beta Function.

```{r}
#create beta function:
beta<- function(ymax, te, tm, t){
  y <- ymax * (1 + (te - t) / (te - tm)) * (t / te)^(te / (te - tm))
  return(y)
}

# Add inital guesses:

beta_test <- crop_data %>% 
  mutate(sim=beta(ymax = 52, te = 280, tm = 220, t= doy))

ggplot(beta_test, aes(x = doy, y = yield, color = "data"))+
  geom_point()+
  geom_line(aes(x = doy, y= sim, color = "model"))+
  scale_color_manual(values= c("data" = "black", "model" = "orange"))+
  theme_bw()
```
```{r}

#guesses:
ymax_guess <- max(crop_data$yield)
te_guess <- 280
tm_guess <- 220

#filter the data:
df_filter <- crop_data %>% 
  filter(!((crop == "F" | crop == "S") & input == 2))

nls_1 <- nls(
  formula = yield ~ beta(ymax, te, tm, doy),
  data = df_filter,
  start = list(ymax = ymax_guess, te = te_guess, tm = tm_guess),
  trace = TRUE)

```


run nls with filter crop f and crop s input 2
new fram- old frame %>% 
run first offical nls 

DOY = t (which is a continuous input)

nls (formula yeild ~ beta(ymax, te, tm, doy) )
data = filterd data
start = list(list variables from guess space )
trace = TRUE

paramater values 

knnit them into a table kable(coef(summary(nls)))



