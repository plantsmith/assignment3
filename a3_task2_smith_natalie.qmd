---
title: "Non-linear Least Squares"
author: "Natalie Smith"
format: 
  html:
    code-fold: true
    toc: true
    number-sections: true
    embed-resources: true
theme: Yeti
editor: visual
execute:
  echo: true
  message: false
  warning: false
---
# Overview: 
Farmers need to understand the biology of plants and their responses to fertilizers to maximize yield. You will help farmers make predictions on their yields by running non-linear least squares on experimental growth data for three grains in Greece. 

Additionally, you will assess the response of the grains to fertlizer. 

You will recreate the model examples of Archontoulis, S.V. and Miguez, F.E. (2015). Read the paper to acquire more insight into nonlinear least squares and its application in agriculture. 

```{r}
library(tidyverse)
library(lterdatasampler)
library(knitr)
library(broom)
library(investr)
library(kableExtra)
library(nlraa)
library(janitor)
```


```{r}
# Access the data from SM package in NLRAA
data <- sm
```

# Variables:

Write a brief description of the data including variable names and structure. 

Variables: 
DOY: Day of Year
Block: location
Input: 
  High = weekly irrigation & applicaton of 200 kg N ha^-1 (fertilizer)
  Low = biweekly irrigation.& application of 50 kg N ha^-1 (fertilizer)
Crop: 
  (F) fiber sorghum
  (S) sweet sorghum 
  (M) maize 
Yield: Biomass

Create finalized summary table of the data in your report. 

Use the Beta function:

Briefly describe what each parameter generally means: 
Y is the response variable (e.g., biomass)
t is the explanatory variable (e.g., time)
Ymax is the asymptotic or the maximum Y value, respectively
tm is the inflection point at which the growth rate is maximized
k controls the steepness of the curve
v deals with the asymmetric growth (if v = 1, then Richards' equation becomes logistic)
a and b are parameters that determine the shape of the curve
te is the time when Y = Yasym
tc is the critical time for a switch-off to occur (e.g., critical photoperiod)
n is a parameter that determines the sharpness of the response


```{r}
#clean the data
crop_data <- data %>% 
  janitor::clean_names() %>%
  mutate(yield = yield + 1) %>% 
  filter(!is.na(crop)) %>% 
  group_by(crop) %>% 
  drop_na()

#BUT ALSO YOU CANNOT LOG 0 so add + 1 to yield but maybe im way off
crop_data <- crop_data %>%
  mutate(yield = yield + 1)

```

Notes from paper:
* Three crops
* two levels of agronomic input
* four blocks
* = 24 possible combinations 

Write a function in R to model the Beta Function.

So i actually think my issue is - I dont know what the variables mean so Idk know to input them?
```{r}
#create beta function:
beta_function <- function(t, ymax, te, tt, tm) {
  y <- ymax * ((1 + (te - t / te - tm)) * ((t / te)^(te / tt - tm)))
  return(y)
}

# Add controls
controls=nls.control(maxiter=100)

#guess model
guess_model <- lm(log(yield) ~ log(doy), data = crop_data)

# Run nls
nls_one <- nls(yield ~ beta_function(t, ymax, te, tt, tmm),
               data = crop_data
               

# nls_one<-nls(weight~length_to_weight(a,b,SV_length),
#              data=lizard_comb,
#              start=list(a=exp(coefficients(guess_model))[1],b=coefficients(guess_model)[2]),
#              control=controls)

# # predictions should be something like this:
# predictions <- data.frame(doy = seq(min(crop_data$doy), max(crop_data$doy), length.out = 100))
#
# #collect the predictions into one df 
# dfplot=data.frame(predict=predictions,length=length_step)

# Make a graph

```


